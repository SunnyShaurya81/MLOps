name: MLOps Pipeline

on:
  push:
    branches: [ main ]

env:
  PYTHON_VERSION: "3.10"

jobs:

  mlops-pipeline:
    runs-on: ubuntu-latest

    steps:
    # -----------------------------
    # 1. Checkout Code
    # -----------------------------
    - name: Checkout repository
      uses: actions/checkout@v3

    # -----------------------------
    # 2. Setup Python
    # -----------------------------
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: ${{ env.PYTHON_VERSION }}

    # -----------------------------
    # 3. Install Dependencies
    # -----------------------------
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r mlops/requirements.txt

    # -----------------------------
    # 4. Verify Hugging Face Token
    # -----------------------------
    - name: Verify HF token
      env:
        HF_TOKEN: ${{ secrets.HF_TOKEN }}
      run: |
        if [ -z "$HF_TOKEN" ]; then
          echo "❌ HF_TOKEN is missing"
          exit 1
        else
          echo "✅ HF_TOKEN detected"
        fi

    # -----------------------------
    # 5. Register Dataset
    # -----------------------------
    - name: Register dataset to Hugging Face
      env:
        HF_TOKEN: ${{ secrets.HF_TOKEN }}
      run: |
        python mlops/model_building/data_register.py

    # -----------------------------
    # 6. Data Preparation
    # -----------------------------
    - name: Data preparation
      env:
        HF_TOKEN: ${{ secrets.HF_TOKEN }}
      run: |
        python mlops/model_building/prep.py

    # -----------------------------
    # 7. Data Validation
    # -----------------------------
    - name: Data validation
      run: |
        python mlops/tests/data_validation.py

    # -----------------------------
    # 8. Model Training
    # -----------------------------
    - name: Model training
      env:
        HF_TOKEN: ${{ secrets.HF_TOKEN }}
      run: |
        python mlops/model_building/train.py

    # -----------------------------
    # 9. Model Testing
    # -----------------------------
    - name: Model testing
      run: |
        python mlops/tests/model_testing.py

    # -----------------------------
    # 10. Deploy to Hugging Face Space
    # -----------------------------
    - name: Deploy to Hugging Face Space
      env:
        HF_TOKEN: ${{ secrets.HF_TOKEN }}
      run: |
        python mlops/hosting/hosting.py
